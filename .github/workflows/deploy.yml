name: Deploy to Hetzner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ğŸš€ SIMPLIFIED DEPLOYMENT"
          
          # Install Node.js if missing (simple approach)
          if ! command -v node >/dev/null 2>&1; then
            echo "Installing Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
            sudo apt-get install -y nodejs
            sudo npm install -g pm2
          fi
          
          # Go to project directory
          cd /root/tahoe-night-nurse || {
            echo "Cloning project..."
            git clone https://github.com/mom-vibecoder/tahoe-night-nurse.git /root/tahoe-night-nurse
            cd /root/tahoe-night-nurse
          }
          
          # Update project
          git pull origin main || git reset --hard origin/main
          
          # Install dependencies
          npm install --production
          
          # Create basic .env if missing
          if [ ! -f .env ]; then
            echo "PORT=3000" > .env
            echo "NODE_ENV=production" >> .env
            echo "BASIC_AUTH_USER=admin" >> .env
            echo "BASIC_AUTH_PASS=changeme123" >> .env
          fi
          
          # Create data directory
          mkdir -p data
          
          # Restart with PM2
          pm2 delete tahoe-night-nurse 2>/dev/null || true
          pm2 start server/index.js --name tahoe-night-nurse
          pm2 save
          
          echo "âœ… Deployment complete!"
          pm2 status