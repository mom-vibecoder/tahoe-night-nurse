name: Deploy to Hetzner

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          echo "ğŸš€ DEPLOYING WITH NODE.JS INSTALLED"
          echo "User: $(whoami)"
          echo "Home: $HOME"
          echo "PWD: $(pwd)"
          echo "OS: $(uname -a)"
          
          echo "ğŸ“¦ Checking prerequisites..."
          which node && node --version || echo "âŒ Node.js not found"
          which npm && npm --version || echo "âŒ npm not found"
          which git && git --version || echo "âŒ git not found"
          which pm2 && pm2 --version || echo "âŒ pm2 not found"
          
          echo "ğŸ” Finding project directory..."
          
          # Check common locations for the project
          if [ -d "/root/tahoe-night-nurse" ]; then
            PROJECT_DIR="/root/tahoe-night-nurse"
            echo "âœ… Found project at: $PROJECT_DIR"
          elif [ -d "/home/$USER/tahoe-night-nurse" ]; then
            PROJECT_DIR="/home/$USER/tahoe-night-nurse"
            echo "âœ… Found project at: $PROJECT_DIR"
          elif [ -d "/var/www/tahoe-night-nurse" ]; then
            PROJECT_DIR="/var/www/tahoe-night-nurse"
            echo "âœ… Found project at: $PROJECT_DIR"
          elif [ -d "~/tahoe-night-nurse" ]; then
            PROJECT_DIR="~/tahoe-night-nurse"
            echo "âœ… Found project at: $PROJECT_DIR"
          else
            echo "âŒ Project directory not found. Creating new one..."
            PROJECT_DIR="/root/tahoe-night-nurse"
            echo "ğŸ“¥ Cloning repository to: $PROJECT_DIR"
            git clone https://github.com/mom-vibecoder/tahoe-night-nurse.git $PROJECT_DIR
          fi
          
          echo "ğŸ“ Using project directory: $PROJECT_DIR"
          cd $PROJECT_DIR || exit 1
          
          echo "ğŸ“¦ Pulling latest changes..."
          git pull origin main || echo "âš ï¸ Git pull failed"
          
          echo "ğŸ“¦ Installing dependencies..."
          npm install --production || echo "âš ï¸ npm install failed"
          
          # Set environment variables if they don't exist
          if [ ! -f .env ]; then
            echo "ğŸ”§ Creating .env file..."
            echo "PORT=3000" > .env
            echo "NODE_ENV=production" >> .env
            echo "DATABASE_PATH=./data/tahoe-night-nurse.db" >> .env
            echo "BASIC_AUTH_USER=admin" >> .env
            echo "BASIC_AUTH_PASS=changeme123" >> .env
            echo "DOMAIN=https://tahoenightnurse.com" >> .env
          else
            echo "âœ… .env file already exists"
          fi
          
          # Ensure data directory exists
          mkdir -p data
          
          echo "ğŸ”„ Restarting application..."
          # Show current directory and files
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“‚ Directory contents:"
          ls -la
          
          # Stop existing process
          pm2 stop tahoe-night-nurse 2>/dev/null || true
          pm2 delete tahoe-night-nurse 2>/dev/null || true
          
          # Start fresh
          echo "ğŸš€ Starting PM2 process from: $(pwd)/server/index.js"
          pm2 start server/index.js --name tahoe-night-nurse
          pm2 save
          
          # Check if SSL is set up (but don't auto-setup to avoid permission issues)
          echo "ğŸ”’ Checking SSL setup..."
          if [ ! -f /etc/letsencrypt/live/tahoenightnurse.com/fullchain.pem ]; then
            echo "âš ï¸ SSL not found. Run setup-ssl.sh manually on server to enable HTTPS"
          else
            echo "âœ… SSL certificate exists"
            # Reload nginx to pick up any config changes (if nginx is running)
            if command -v nginx >/dev/null 2>&1; then
              sudo nginx -t && sudo systemctl reload nginx 2>/dev/null || echo "âš ï¸ Nginx reload failed"
            fi
          fi
          
          echo "âœ… Deployment complete!"
          echo "ğŸ“Š PM2 Status:"
          pm2 status
          echo "ğŸ“ Recent logs:"
          pm2 logs tahoe-night-nurse --lines 10 --nostream
          echo "ğŸŒ Site should be available at: https://tahoenightnurse.com"